<div class="mfp-popup popup-selection mfp-anim">
  <div class="mfp-inner header-nav-menu-inner popup-selection-inner ui-noise">
    <div class="menu-aside">
      <div class="menu-aside-head">
        <div class="menu-aside-title">
          Подбор услуги
        </div>
        <div class="menu-aside-subtitle">
          Выберите беспокоящую вас проблему, и мы подберем услуги, которые помогут ее решить.
        </div>
      </div>
      <div class="menu-aside-nav menu-aside-nav__mid">
        <ul>
          <li>
            <a href="#" class="active">
              <img src="./images/svg/icons-service.svg" alt="icon" class="menu-aside-icon">
              Косметология для кожи лица и тела
              <img class="mobile-menu-arrow hidden-desktop" src="./images/svg/menu-arrow-right.svg" alt="Подменю">
            </a>
          </li>
          <li>
            <a href="#">
              <img src="./images/svg/icons-service-5.svg" alt="icon" class="menu-aside-icon">
              Многопрофильная медицина
              <img class="mobile-menu-arrow hidden-desktop" src="./images/svg/menu-arrow-right.svg" alt="Подменю">
            </a>
          </li>
          <li>
            <a href="#">
              <img src="./images/svg/icons-service-8.svg" alt="icon" class="menu-aside-icon">
              SPA
              <img class="mobile-menu-arrow hidden-desktop" src="./images/svg/menu-arrow-right.svg" alt="Подменю">
            </a>
          </li>
          <li>
            <a href="#">
              <img src="./images/svg/icons-service-3.svg" alt="icon" class="menu-aside-icon">
              Beauty
              <img class="mobile-menu-arrow hidden-desktop" src="./images/svg/menu-arrow-right.svg" alt="Подменю">
            </a>
          </li>
        </ul>
      </div>
    </div>
    <div class="menu-main">
      <div class="menu-main-section">
        <div class="menu-aside-title hidden-desktop">
          Подбор услуги
        </div>
        <a href="#" class="menu-main-back hidden-desktop">
          <svg class="menu-main-back-icon">
            <use xlink:href="svg/svg/symbols.svg#arrow-left"></use>
          </svg>
          <span>Назад</span>
        </a>
        <a href="#" class="menu-main-title">
          Косметология для кожи лица и тела
        </a>
        <div class="row flex-grow">
          <div class="col-md-12 col-lg-4">
            <a href="#" class="service-selection">
              <div class="service-selection-title">
                Улучшение качества кожи
              </div>
              <img
                src="./images/service-5.jpg"
                alt="injections"
                class="service-preview-image hidden-tablet"
                width="391"
                height="400"
                loading="lazy"
              >
              <div class="service-selection-count ui-noise hidden-tablet">
                <span class="service-selection-count-value">32 услуги</span>
              </div>
            </a>
          </div>
          <div class="col-md-12 col-lg-4">
            <a href="#" class="service-selection">
              <div class="service-selection-title">
                Омоложение
              </div>
              <img
                src="./images/service-6.jpg"
                alt="injections"
                class="service-preview-image hidden-tablet"
                width="391"
                height="400"
                loading="lazy"
              >
              <div class="service-selection-count ui-noise hidden-tablet">
                <span class="service-selection-count-value">32 услуги</span>
              </div>
            </a>
          </div>
          <div class="col-md-12 col-lg-4">
            <a href="#" class="service-selection">
              <div class="service-selection-title">
                Коррекция формы лица
              </div>
              <img
                src="./images/service-7.jpg"
                alt="injections"
                class="service-preview-image hidden-tablet"
                width="391"
                height="400"
                loading="lazy"
              >
              <div class="service-selection-count ui-noise hidden-tablet">
                <span class="service-selection-count-value">32 услуги</span>
              </div>
            </a>
          </div>
          <div class="col-md-12 col-lg-4">
            <a href="#" class="service-selection">
              <div class="service-selection-title">
                Лечение акне/постакне
              </div>
              <img
                src="./images/service-8.jpg"
                alt="injections"
                class="service-preview-image hidden-tablet"
                width="391"
                height="400"
                loading="lazy"
              >
              <div class="service-selection-count ui-noise hidden-tablet">
                <span class="service-selection-count-value">32 услуги</span>
              </div>
            </a>
          </div>
          <div class="col-md-12 col-lg-4">
            <a href="#" class="service-selection">
              <div class="service-selection-title">
                Коррекция фигуры
              </div>
              <img
                src="./images/service-5.jpg"
                alt="injections"
                class="service-preview-image hidden-tablet"
                width="391"
                height="400"
                loading="lazy"
              >
              <div class="service-selection-count ui-noise hidden-tablet">
                <span class="service-selection-count-value">32 услуги</span>
              </div>
            </a>
          </div>
          <div class="col-md-12 col-lg-4">
            <a href="#" class="service-selection">
              <div class="service-selection-title">
                Лечение потливости
              </div>
              <img
                src="./images/service-6.jpg"
                alt="injections"
                class="service-preview-image hidden-tablet"
                width="391"
                height="400"
                loading="lazy"
              >
              <div class="service-selection-count ui-noise hidden-tablet">
                <span class="service-selection-count-value">32 услуги</span>
              </div>
            </a>
          </div>
          <div class="col-md-12 col-lg-4">
            <a href="#" class="service-selection">
              <div class="service-selection-title">
                Коррекция рубцов и стрий
              </div>
              <img
                src="./images/service-5.jpg"
                alt="injections"
                class="service-preview-image hidden-tablet"
                width="391"
                height="400"
                loading="lazy"
              >
              <div class="service-selection-count ui-noise hidden-tablet">
                <span class="service-selection-count-value">32 услуги</span>
              </div>
            </a>
          </div>
          <div class="col-md-12 col-lg-4">
            <a href="#" class="service-selection">
              <div class="service-selection-title">
                Улучшение качества кожи
              </div>
              <img
                src="./images/service-6.jpg"
                alt="injections"
                class="service-preview-image hidden-tablet"
                width="391"
                height="400"
                loading="lazy"
              >
              <div class="service-selection-count ui-noise hidden-tablet">
                <span class="service-selection-count-value">32 услуги</span>
              </div>
            </a>
          </div>
          <div class="col-md-12 col-lg-4">
            <a href="#" class="service-selection last">
              <div class="service-selection-title">
                Консультация косметолога
              </div>
              <img
                src="./images/service-7.jpg"
                alt="injections"
                class="service-preview-image hidden-tablet"
                width="391"
                height="400"
                loading="lazy"
              >
              <div class="service-selection-count ui-noise hidden-tablet">
                <span class="service-selection-count-value">32 услуги</span>
              </div>
            </a>
          </div>
        </div>
      </div>
      <div class="menu-main-section">
        <div class="menu-aside-title hidden-desktop">
          Подбор услуги
        </div>
        <a href="#" class="menu-main-back hidden-desktop">
          Назад
        </a>
        <a href="#" class="menu-main-title">
          Многопрофильная медицина
        </a>
        <div class="row flex-grow">
          <div class="col-md-12 col-lg-4">
            <a href="#" class="service-selection">
              <div class="service-selection-title">
                Улучшение качества кожи
              </div>
              <img
                src="./images/service-5.jpg"
                alt="injections"
                class="service-preview-image hidden-tablet"
                width="391"
                height="400"
                loading="lazy"
              >
              <div class="service-selection-count ui-noise hidden-tablet">
                <span class="service-selection-count-value">32 услуги</span>
              </div>
            </a>
          </div>
          <div class="col-md-12 col-lg-4">
            <a href="#" class="service-selection">
              <div class="service-selection-title">
                Омоложение
              </div>
              <img
                src="./images/service-6.jpg"
                alt="injections"
                class="service-preview-image hidden-tablet"
                width="391"
                height="400"
                loading="lazy"
              >
              <div class="service-selection-count ui-noise hidden-tablet">
                <span class="service-selection-count-value">32 услуги</span>
              </div>
            </a>
          </div>
          <div class="col-md-12 col-lg-4">
            <a href="#" class="service-selection">
              <div class="service-selection-title">
                Коррекция формы лица
              </div>
              <img
                src="./images/service-7.jpg"
                alt="injections"
                class="service-preview-image hidden-tablet"
                width="391"
                height="400"
                loading="lazy"
              >
              <div class="service-selection-count ui-noise hidden-tablet">
                <span class="service-selection-count-value">32 услуги</span>
              </div>
            </a>
          </div>
          <div class="col-md-12 col-lg-4">
            <a href="#" class="service-selection">
              <div class="service-selection-title">
                Лечение акне/постакне
              </div>
              <img
                src="./images/service-8.jpg"
                alt="injections"
                class="service-preview-image hidden-tablet"
                width="391"
                height="400"
                loading="lazy"
              >
              <div class="service-selection-count ui-noise hidden-tablet">
                <span class="service-selection-count-value">32 услуги</span>
              </div>
            </a>
          </div>
          <div class="col-md-12 col-lg-4">
            <a href="#" class="service-selection">
              <div class="service-selection-title">
                Коррекция фигуры
              </div>
              <img
                src="./images/service-5.jpg"
                alt="injections"
                class="service-preview-image hidden-tablet"
                width="391"
                height="400"
                loading="lazy"
              >
              <div class="service-selection-count ui-noise hidden-tablet">
                <span class="service-selection-count-value">32 услуги</span>
              </div>
            </a>
          </div>
        </div>
      </div>
      <div class="menu-main-section">
        <div class="menu-aside-title hidden-desktop">
          Подбор услуги
        </div>
        <a href="#" class="menu-main-back hidden-desktop">
          Назад
        </a>
        <a href="#" class="menu-main-title">
          SPA
        </a>
        <div class="row flex-grow">
          <div class="col-md-12 col-lg-4">
            <a href="#" class="service-selection">
              <div class="service-selection-title">
                Улучшение качества кожи
              </div>
              <img
                src="./images/service-5.jpg"
                alt="injections"
                class="service-preview-image hidden-tablet"
                width="391"
                height="400"
                loading="lazy"
              >
              <div class="service-selection-count ui-noise hidden-tablet">
                <span class="service-selection-count-value">32 услуги</span>
              </div>
            </a>
          </div>
          <div class="col-md-12 col-lg-4">
            <a href="#" class="service-selection">
              <div class="service-selection-title">
                Омоложение
              </div>
              <img
                src="./images/service-6.jpg"
                alt="injections"
                class="service-preview-image hidden-tablet"
                width="391"
                height="400"
                loading="lazy"
              >
              <div class="service-selection-count ui-noise hidden-tablet">
                <span class="service-selection-count-value">32 услуги</span>
              </div>
            </a>
          </div>
          <div class="col-md-12 col-lg-4">
            <a href="#" class="service-selection">
              <div class="service-selection-title">
                Коррекция формы лица
              </div>
              <img
                src="./images/service-7.jpg"
                alt="injections"
                class="service-preview-image hidden-tablet"
                width="391"
                height="400"
                loading="lazy"
              >
              <div class="service-selection-count ui-noise hidden-tablet">
                <span class="service-selection-count-value">32 услуги</span>
              </div>
            </a>
          </div>
        </div>
      </div>
      <div class="menu-main-section">
        <div class="menu-aside-title hidden-desktop">
          Подбор услуги
        </div>
        <a href="#" class="menu-main-back hidden-desktop">
          Назад
        </a>
        <a href="#" class="menu-main-title">
          Beauty
        </a>
        <div class="row flex-grow">
          <div class="col-md-12 col-lg-4">
            <a href="#" class="service-selection">
              <div class="service-selection-title">
                Улучшение качества кожи
              </div>
              <img
                src="./images/service-5.jpg"
                alt="injections"
                class="service-preview-image hidden-tablet"
                width="391"
                height="400"
                loading="lazy"
              >
              <div class="service-selection-count ui-noise hidden-tablet">
                <span class="service-selection-count-value">32 услуги</span>
              </div>
            </a>
          </div>
          <div class="col-md-12 col-lg-4">
            <a href="#" class="service-selection">
              <div class="service-selection-title">
                Омоложение
              </div>
              <img
                src="./images/service-6.jpg"
                alt="injections"
                class="service-preview-image hidden-tablet"
                width="391"
                height="400"
                loading="lazy"
              >
              <div class="service-selection-count ui-noise hidden-tablet">
                <span class="service-selection-count-value">32 услуги</span>
              </div>
            </a>
          </div>
          <div class="col-md-12 col-lg-4">
            <a href="#" class="service-selection">
              <div class="service-selection-title">
                Коррекция формы лица
              </div>
              <img
                src="./images/service-7.jpg"
                alt="injections"
                class="service-preview-image hidden-tablet"
                width="391"
                height="400"
                loading="lazy"
              >
              <div class="service-selection-count ui-noise hidden-tablet">
                <span class="service-selection-count-value">32 услуги</span>
              </div>
            </a>
          </div>
        </div>
      </div>
    </div>
  </div>
  <script>
    // function initializePopupMenu() {
    //   const menuMain = document.querySelector('.popup-selection .menu-main');
    //   const asideLinks = document.querySelectorAll('.popup-selection .menu-aside-nav > ul > li > a');
    //   const mainSections = document.querySelectorAll('.popup-selection .menu-main-section');    

    //   let scrollOffset = parseInt(window.getComputedStyle(menuMain).marginTop, 10);
    //   let selectedIndex = null;
    //   let visibleSections = new Set();   

    //   function smoothScroll(target, duration) {
    //     const targetPosition = target.offsetTop - scrollOffset;
    //     const startPosition = menuMain.scrollTop;
    //     const distance = targetPosition - startPosition;
    //     let startTime = null;

    //     function animation(currentTime) {
    //       if (startTime === null) startTime = currentTime;
    //       const timeElapsed = currentTime - startTime;
    //       const run = ease(timeElapsed, startPosition, distance, duration);
    //       menuMain.scrollTo(0, run);
    //       if (timeElapsed < duration) requestAnimationFrame(animation);
    //     }

    //     function ease(t, b, c, d) {
    //       t /= d / 2;
    //       if (t < 1) return c / 2 * t * t + b;
    //       t--;
    //       return -c / 2 * (t * (t - 2) - 1) + b;
    //     }

    //     requestAnimationFrame(animation);
    //   }   

    //   function updateActiveLink() {
    //     let activeIndex;

    //     if (selectedIndex !== null && visibleSections.has(selectedIndex)) {
    //       activeIndex = selectedIndex;
    //     } else if (visibleSections.size > 0) {
    //       activeIndex = Math.min(...visibleSections);
    //     } else {
    //       activeIndex = 0;
    //     }

    //     let hasActiveLink = false;
    //     asideLinks.forEach((link, index) => {
    //       if (index === activeIndex) {
    //         link.classList.add('active');
    //         hasActiveLink = true;
    //       } else {
    //         link.classList.remove('active');
    //       }
    //     });

    //     if (!hasActiveLink) {
    //       asideLinks[0].classList.add('active');
    //     }      
    //   }

    //   const observer = new IntersectionObserver((entries) => {
    //     entries.forEach(entry => {
    //       const index = Array.from(mainSections).indexOf(entry.target);
    //       if (entry.isIntersecting) {
    //         visibleSections.add(index);
    //       } else {
    //         visibleSections.delete(index);
    //       }
    //     });
    //     if (selectedIndex === null) {
    //       updateActiveLink();
    //     }
    //   }, {
    //     root: menuMain,
    //     rootMargin: `-${scrollOffset}px 0px -${scrollOffset}px 0px`,
    //     threshold: 0.1
    //   });

    //   mainSections.forEach(section => observer.observe(section));

    //   function handleAsideLinkClick(e, index) {
    //     e.preventDefault();
    //     selectedIndex = index;
    //     smoothScroll(mainSections[index], 500);
    //     updateActiveLink();
    //   }

    //   asideLinks.forEach((link, index) => {
    //     link.addEventListener('click', (e) => handleAsideLinkClick(e, index));
    //   });

    //   function handleMenuMainScroll() {
    //     if (menuMain.scrollTop === 0) {
    //       selectedIndex = null;
    //     }
    //     updateActiveLink();
    //   }

    //   menuMain.addEventListener('scroll', handleMenuMainScroll);

    //   function handleWindowResize() {
    //     scrollOffset = parseInt(window.getComputedStyle(menuMain).marginTop, 10);
    //     observer.disconnect();
    //     observer.rootMargin = `-${scrollOffset}px 0px -${scrollOffset}px 0px`;
    //     mainSections.forEach(section => observer.observe(section));
    //   }

    //   window.addEventListener('resize', handleWindowResize);

    //   // Функция очистки
    //   function cleanup() {
    //     observer.disconnect();
    //     asideLinks.forEach((link, index) => {
    //       link.removeEventListener('click', (e) => handleAsideLinkClick(e, index));
    //     });
    //     menuMain.removeEventListener('scroll', handleMenuMainScroll);
    //     window.removeEventListener('resize', handleWindowResize);
    //   }

    //   // Возвращаем функцию очистки
    //   return cleanup;
    // }

    // initializePopupMenu();



    function initializePopupMenu() {
  const menuMain = document.querySelector('.popup-selection .menu-main');
  const asideLinks = document.querySelectorAll('.popup-selection .menu-aside-nav > ul > li > a');
  const mainSections = document.querySelectorAll('.popup-selection .menu-main-section');    

  let scrollOffset = parseInt(window.getComputedStyle(menuMain).marginTop, 10);
  let selectedIndex = null;
  let visibleSections = new Set();   
  let isDesktop = window.innerWidth >= 900;

  function smoothScroll(target, duration) {
    const targetPosition = target.offsetTop - scrollOffset;
    const startPosition = menuMain.scrollTop;
    const distance = targetPosition - startPosition;
    let startTime = null;

    function animation(currentTime) {
      if (startTime === null) startTime = currentTime;
      const timeElapsed = currentTime - startTime;
      const run = ease(timeElapsed, startPosition, distance, duration);
      menuMain.scrollTo(0, run);
      if (timeElapsed < duration) requestAnimationFrame(animation);
    }

    function ease(t, b, c, d) {
      t /= d / 2;
      if (t < 1) return c / 2 * t * t + b;
      t--;
      return -c / 2 * (t * (t - 2) - 1) + b;
    }

    requestAnimationFrame(animation);
  }   

  function updateActiveLink() {
    if (isDesktop) {
      let activeIndex;

      if (selectedIndex !== null && visibleSections.has(selectedIndex)) {
        activeIndex = selectedIndex;
      } else if (visibleSections.size > 0) {
        activeIndex = Math.min(...visibleSections);
      } else {
        activeIndex = 0;
      }

      let hasActiveLink = false;
      asideLinks.forEach((link, index) => {
        if (index === activeIndex) {
          link.classList.add('active');
          hasActiveLink = true;
        } else {
          link.classList.remove('active');
        }
      });

      if (!hasActiveLink) {
        asideLinks[0].classList.add('active');
      }
    }
  }

  const observer = new IntersectionObserver((entries) => {
    if (isDesktop) {
      entries.forEach(entry => {
        const index = Array.from(mainSections).indexOf(entry.target);
        if (entry.isIntersecting) {
          visibleSections.add(index);
        } else {
          visibleSections.delete(index);
        }
      });
      if (selectedIndex === null) {
        updateActiveLink();
      }
    }
  }, {
    root: menuMain,
    rootMargin: `-${scrollOffset}px 0px -${scrollOffset}px 0px`,
    threshold: 0.1
  });

  function handleAsideLinkClick(e, index) {
    e.preventDefault();
    if (isDesktop) {
      selectedIndex = index;
      smoothScroll(mainSections[index], 500);
      updateActiveLink();
    } else {
      // Логика для мобильных устройств      
      asideLinks.forEach(link => link.classList.remove('active'));
      e.target.classList.add('active');
      mainSections.forEach((section, i) => {
        if (i === index) {
          section.classList.add('active');
        } else {
          section.classList.remove('active');
        }
      });
    }
  }

  asideLinks.forEach((link, index) => {
    link.addEventListener('click', (e) => handleAsideLinkClick(e, index));
  });

  function handleMenuMainScroll() {
    if (isDesktop) {
      if (menuMain.scrollTop === 0) {
        selectedIndex = null;
      }
      updateActiveLink();
    }
  }

  menuMain.addEventListener('scroll', handleMenuMainScroll);

  function handleWindowResize() {
    isDesktop = window.innerWidth >= 900;
    if (isDesktop) {
      scrollOffset = parseInt(window.getComputedStyle(menuMain).marginTop, 10);
      observer.disconnect();
      observer.rootMargin = `-${scrollOffset}px 0px -${scrollOffset}px 0px`;
      mainSections.forEach(section => observer.observe(section));
      updateActiveLink();
    } else {
      // Сброс для мобильной версии
      asideLinks.forEach(link => link.classList.remove('active'));
      mainSections.forEach(section => section.classList.remove('active'));
    }
  }

  window.addEventListener('resize', handleWindowResize);
  handleWindowResize(); // Вызываем сразу для инициализации

  // назад
  const backButtons = document.querySelectorAll('.menu-main-back');

  backButtons.forEach(back => {   
    back.addEventListener('click', (ev) => {
      ev.preventDefault()
      mainSections.forEach(section => {
        section.classList.remove('active');
      })
    })
  })

  if (isDesktop) {
    mainSections.forEach(section => observer.observe(section));
  }

  // Функция очистки
  function cleanup() {
    observer.disconnect();
    asideLinks.forEach((link, index) => {
      link.removeEventListener('click', (e) => handleAsideLinkClick(e, index));
    });
    menuMain.removeEventListener('scroll', handleMenuMainScroll);
    window.addEventListener('resize', handleWindowResize);
  }

  // Возвращаем функцию очистки
  return cleanup;  

}

initializePopupMenu();
  </script>
</div>
