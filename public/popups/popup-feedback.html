<div class="mfp-popup popup-feedback mfp-anim">
  <div class="mfp-inner">
    <form class="popup-feedback-form">
      <div class="popup-feedback-top">
        <div class="popup-feedback-title">
          Обратная связь
        </div>
        <div class="popup-feedback-text">
          Оставьте свои контактные данные,
          <br>
          и мы свяжемся с вами в ближайшее время
        </div>
        <div class="inputs-wrapper">
          <label class="input-item input-item__half">
            <div class="ui-field ui-field__input required">
              <span class="ui-label">Ваше имя</span>
              <input
                type="text"
                name="name"
                id="name"
                class="ui-input"
                required
              >
            </div>
          </label>
          <label class="input-item input-item__half">
            <div class="ui-field ui-field__input required">
              <span class="ui-label">Телефон</span>
              <input
                type="text"
                name="tel"
                id="tel"
                class="ui-input ux-phonemask"
                required
              >
            </div>
          </label>
          <label class="textarea-item">
            <div class="ui-field ui-field__textarea required">
              <span class="ui-label ui-label__textarea">Комментарий</span>
              <textarea
                name="comment"
                id="comment"
                class="ui-textarea"
                required
              ></textarea>
            </div>
          </label>
        </div>
      </div>
      <div class="popup-feedback-bottom">
        <input
          type="checkbox"
          name="agree"
          id="agree"
          class="ui-checkbox"
        >
        <div class="popup-feedback-agree">
          Я принимаю условия
          <a href="#">политики конфиденциальности</a>
          и даю согласие на обработку своих персональных данных
          <span class="error hidden">
            Поле обязательно для заполнения
          </span>
        </div>
        <button type="submit" class="ui-btn ui-btn-opacity disabled">
          Отправить
          <svg class="ui-btn-icon">
            <use xlink:href="svg/svg/symbols.svg#ui-icons-right"/>
          </svg>
        </button>
      </div>
    </form>
  </div>
  <script>
    $(document).ready(function () {
      document.querySelectorAll('.ui-field.required > .ui-input').forEach(input => {
        input.addEventListener('focus', () => {
          input.closest('.ui-field').classList.add('input-active');
        });
        
        input.addEventListener('blur', () => {
          if (!input.value) {
            input.closest('.ui-field').classList.remove('input-active');
          }
        });
        
        input.addEventListener('input', () => {
          if (input.value) {
            input.closest('.ui-field').classList.add('input-active');
          } else {
            input.closest('.ui-field').classList.remove('input-active');
          }
        });
      });

      document.querySelectorAll('.ui-field.required > .ui-textarea').forEach(input => {
        input.addEventListener('focus', () => {
          input.closest('.ui-field').classList.add('input-active');
        });
        
        input.addEventListener('blur', () => {
          if (!input.value) {
            input.closest('.ui-field').classList.remove('input-active');
          }
        });
        
        input.addEventListener('input', () => {
          if (input.value) {
            input.closest('.ui-field').classList.add('input-active');
          } else {
            input.closest('.ui-field').classList.remove('input-active');
          }
        });
      });

      $('.ui-select, .ui-checkbox').styler();

      $.validator.addMethod("noDigits", function(value, element) {
        return this.optional(element) || !/\d/.test(value);
      }, 'Неправильно заполнено поле');

      $.validator.addMethod("phone", function (value, element) {
        if (value.startsWith('+375')) {
          return /^(\s*)?(\+)?([- _():=+]?\d[- _():=+]?){12}(\s*)?$/i.test(value);
        } else if (value.startsWith('+7')) {
          return /^(\s*)?(\+)?([- _():=+]?\d[- _():=+]?){11}(\s*)?$/i.test(value);
        } else {
          return /^(\s*)?(\+)?([- _():=+]?\d[- _():=+]?){11,14}(\s*)?$/i.test(value);
        }
      }, "Неправильно заполнено поле");

      $.validator.messages.required = 'Не заполнено поле';

      let form = $(".popup-feedback-form");
      let submitButton = form.find(".ui-btn");
      let agreeErrorElement = $(".popup-feedback-agree .error");
      let wasValid = false;
      let fieldsChanged = {};

      let validator = form.validate({
        submitHandler: function(form, event) {
          event.preventDefault();
          form.reset();
          wasValid = false;
          fieldsChanged = {};
          updateSubmitButton();
          updateAgreeErrorVisibility(true);
        },
        rules: {
          name: { noDigits: true, required: true },
          tel: { phone: true, required: true },
          comment: { required: true },
          agree: { required: true },
        },
        errorPlacement: function(error, element) {
          if (element.attr('name') !== 'agree' && fieldsChanged[element.attr('name')]) {
            error.insertAfter(element);
          }
        },
        ignore: ":hidden:not(#agree)"
      });

      let debounceTimer;
      form.on('input', 'input, textarea', function() {
        var fieldName = $(this).attr('name');
        fieldsChanged[fieldName] = true;
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(validateForm, 300);
      });

      form.on('change', 'input[type="checkbox"]', function() {
        let fieldName = $(this).attr('name');
        fieldsChanged[fieldName] = true;
        validateForm();
      });

      function validateForm() {
        let isCurrentlyValid = validator.checkForm();
        
        if (wasValid && !isCurrentlyValid) {
          validator.form();
        } else {
          form.find('input, textarea').each(function() {
            let field = $(this);
            let fieldName = field.attr('name');
            if (fieldsChanged[fieldName]) {
              validator.element(field);
            }
          });
        }

        wasValid = isCurrentlyValid;
        updateSubmitButton(isCurrentlyValid);
        updateAgreeErrorVisibility();
      }

      function updateSubmitButton(isValid) {
        if (isValid) {
          submitButton.removeClass("disabled");
        } else {
          submitButton.addClass("disabled");
        }
      }

      function updateAgreeErrorVisibility(forceHide) {
        let agreeField = form.find('#agree');
        if (forceHide || (fieldsChanged['agree'] && agreeField.valid())) {
          agreeErrorElement.addClass('hidden');
        } else if (fieldsChanged['agree'] && !agreeField.valid()) {
          agreeErrorElement.removeClass('hidden');
        }
      }

      // Инициализация состояния кнопки и сообщения об ошибке при загрузке страницы
      updateSubmitButton(false);
      updateAgreeErrorVisibility(true);          

      // маска ввода номера телефона
      function initMask() {
        const phoneInputs = document.querySelectorAll('.ux-phonemask');      
      
        if (phoneInputs.length) {
          phoneInputs.forEach(element => {
            IMask(element, {
              mask: '+{7} (000) 000-00-00',
              lazy: false,
              placeholderChar: '_'
            });
          });
        }        
      }
      
      initMask();
        });
  </script>
</div>
